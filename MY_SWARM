#!/usr/bin/env pil

(setq *TheScript (text "@1@2" (car (file)) (cadr (file))))

(if (> (native "@" "readlink" 'N *TheScript '(Buf (4096 C . 4096 )) 4096) 0)
	(setq *InstallDir (dirname (glue "" Buf)))
	(setq *InstallDir (car (file))) )

(setq ConfigFile (text "@1@2" *InstallDir "config.rc"))
(setq PidFile (text "@1@2" *InstallDir "pid.rc"))

(when (= (argv) '("restart"))
	(kill (rc PidFile 'Pid) 1)
	(bye) )

(when (rc PidFile 'Pid)
	(let OPid @
		(when (info (text "/proc/@1" OPid))
			(prinl "Fatal error: instance already active on pid " OPid "; shutting down")
			(bye 2) ) ) )

(rc PidFile 'Pid *Pid)

(setq WorkerPids ())

(setq NeedsStopWorkers NIL)
(setq *Hup '(
	(setq NeedsStopWorkers T)
	))

(de StartWorkers
	()
	(mapcar
		'((Rcd)
			(let Dir (car Rcd)
				(if (fork)
					(push 'WorkerPids @)

					(detach)
					(setq *Hup '((kill 0)))
					(unless (fork)
						(cd Dir)
						(exec "./SWARM_SERVE" (; Rcd 2) (; Rcd 3)) )
					(finally
						(prog (prinl "sending (kill 0) in the CHILD process")(kill 0))
						(do T
#							(prin "x")(flush)
							(wait 6000) ) ) ) ) )
		(rc ConfigFile 'Servers) ) )

(de StopWorkers
	()
	(while (pop 'WorkerPids)
#		(prinl "stopping worker " @)
		(kill @ 1) ) )

(StartWorkers)

(finally
	(StopWorkers)
	(do T
#		(prin ".")(flush)
		(when NeedsStopWorkers
			(StopWorkers) )
		(unless WorkerPids
			(StartWorkers) )
		(native "@" "sleep" 'I 2) ) )

(bye)
