#!/usr/bin/env pil

(setq *TheScript (text "@1@2" (car (file)) (cadr (file))))

(if (> (native "@" "readlink" 'N *TheScript '(Buf (4096 C . 4096 )) 4096) 0)
	(setq *InstallDir (dirname (glue "" Buf)))
	(setq *InstallDir (car (file))) )

(setq ConfigFile (text "@1@2" *InstallDir "config.rc"))
(setq PidFile (text "@1@2" *InstallDir "pid.rc"))

(when (rc PidFile 'Pid)
	(let OPid @
		(when (info (text "/proc/@1" OPid))
			(prinl "Fatal error: instance already active on pid " OPid "; shutting down")
			(bye 2) ) ) )

(rc PidFile 'Pid *Pid)

(setq WorkerPids ())

(de StartWorkers
	()
	(mapcar
		'((Rcd)
			(let Dir (car Rcd)
				(if (fork)
					(push 'WorkerPids @)
					(cd Dir)
					(exec "./SWARM_SERVE" (; Rcd 2) (; Rcd 3)) ) ) )
		(rc ConfigFile 'Servers) ) )

(StartWorkers)

(finally
	(kill 0)
	(do T
#		(prin ".")(flush)
		(wait 5000) ) )

(bye)
